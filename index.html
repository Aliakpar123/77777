<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merci Wish List</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        * { box-sizing: border-box; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: slideUp 0.4s ease-out; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        const BRANDS = [
            { name: '–ó–æ–ª–æ—Ç–æ–µ –Ø–±–ª–æ–∫–æ', logo: 'https://logo.clearbit.com/goldapple.ru', color: 'from-yellow-400 to-amber-500' },
            { name: 'Tiffany & Co.', logo: 'https://logo.clearbit.com/tiffany.com', color: 'from-cyan-400 to-blue-400' },
            { name: 'Cartier', logo: 'https://logo.clearbit.com/cartier.com', color: 'from-red-600 to-red-700' },
            { name: '12 STOREEZ', logo: 'https://logo.clearbit.com/12storeez.com', color: 'from-gray-800 to-black' },
            { name: 'Zara', logo: 'https://logo.clearbit.com/zara.com', color: 'from-gray-700 to-gray-900' },
            { name: 'Mango', logo: 'https://logo.clearbit.com/mango.com', color: 'from-orange-400 to-orange-500' },
            { name: 'H&M', logo: 'https://logo.clearbit.com/hm.com', color: 'from-red-500 to-red-600' },
            { name: 'Massimo Dutti', logo: 'https://logo.clearbit.com/massimodutti.com', color: 'from-amber-700 to-amber-900' },
            { name: 'Bershka', logo: 'https://logo.clearbit.com/bershka.com', color: 'from-pink-500 to-rose-600' },
            { name: 'LOVE REPUBLIC', logo: 'https://logo.clearbit.com/loverepublic.ru', color: 'from-pink-400 to-pink-600' },
            { name: 'Zarina', logo: 'https://logo.clearbit.com/zarina.ru', color: 'from-purple-400 to-purple-600' },
            { name: 'Wildberries', logo: 'https://logo.clearbit.com/wildberries.ru', color: 'from-purple-600 to-purple-800' },
            { name: 'Ozon', logo: 'https://logo.clearbit.com/ozon.ru', color: 'from-blue-600 to-blue-700' },
            { name: 'Lamoda', logo: 'https://logo.clearbit.com/lamoda.ru', color: 'from-pink-500 to-purple-600' },
            { name: 'Calzedonia', logo: 'https://logo.clearbit.com/calzedonia.com', color: 'from-rose-400 to-pink-500' }
        ];

        let currentView = 'home';
        let wishes = [];
        let showAddForm = false;
        let editingId = null;
        let formData = { title: '', shopUrl: '', price: '', image: '' };
        let isGuestMode = false;
        let guestWishes = [];
        let guestOwner = null;
        let currentUser = null;

        function initUser() {
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                currentUser = {
                    id: window.Telegram.WebApp.initDataUnsafe.user.id,
                    username: window.Telegram.WebApp.initDataUnsafe.user.username || 'user_' + window.Telegram.WebApp.initDataUnsafe.user.id,
                    firstName: window.Telegram.WebApp.initDataUnsafe.user.first_name,
                    lastName: window.Telegram.WebApp.initDataUnsafe.user.last_name
                };
            } else {
                currentUser = {
                    id: Date.now(),
                    username: 'demo_user',
                    firstName: '–î–µ–º–æ',
                    lastName: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                };
            }
            loadWishes();
        }

        function loadWishes() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º start –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ Telegram
            if (window.Telegram?.WebApp?.initDataUnsafe?.start_param) {
                const startParam = window.Telegram.WebApp.initDataUnsafe.start_param;
                
                if (startParam.startsWith('share_')) {
                    loadSharedWishes(startParam.replace('share_', ''));
                    return;
                }
            }
            
            // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–π —Å–ø–∏—Å–æ–∫
            const saved = localStorage.getItem('merci_wishes');
            if (saved) wishes = JSON.parse(saved);
        }

        function loadSharedWishes(token) {
            try {
                const saved = localStorage.getItem(`share_${token}`);
                if (saved) {
                    const data = JSON.parse(saved);
                    guestWishes = data.wishes || [];
                    guestOwner = data.owner || null;
                    isGuestMode = true;
                    currentView = 'mylist';
                }
            } catch (e) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫');
            }
        }

        function saveWishes() {
            localStorage.setItem('merci_wishes', JSON.stringify(wishes));
        }

        function render() {
            const app = document.getElementById('app');
            
            if (currentView === 'home') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50 pb-8">
                        <div class="px-6 pt-8 pb-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="bg-gradient-to-br from-pink-400 to-purple-500 p-3 rounded-2xl shadow-lg text-3xl">
                                    üéÅ
                                </div>
                                <div>
                                    <h1 class="text-4xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">Merci</h1>
                                    <p class="text-sm text-gray-500">Wish List</p>
                                </div>
                            </div>

                            <button onclick="goToMyList()" class="w-full bg-gradient-to-r from-pink-400 to-purple-500 rounded-3xl p-6 mb-6 shadow-xl hover:shadow-2xl transition-all">
                                <div class="flex items-center justify-between">
                                    <div class="text-left">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="text-2xl">‚ù§Ô∏è</span>
                                            <h3 class="text-xl font-bold text-white">–ú–æ–π Wish List</h3>
                                        </div>
                                        <p class="text-pink-100 text-sm">${wishes.length > 0 ? wishes.length + ' –∂–µ–ª–∞–Ω–∏–π' : '–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Å–ø–∏—Å–æ–∫'}</p>
                                    </div>
                                    <div class="text-2xl text-white">‚Üí</div>
                                </div>
                            </button>
                        </div>

                        <div class="px-6">
                            <h2 class="text-2xl font-bold mb-4 text-gray-700">–ò–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤</h2>
                            <div class="overflow-x-auto -mx-6 px-6">
                                <div class="flex gap-4 pb-4">
                                    ${BRANDS.map((brand, i) => `
                                        <button onclick="showBrandModal('${brand.name}')" class="flex-shrink-0 w-32 transform hover:scale-105 transition-all">
                                            <div class="bg-white rounded-3xl aspect-square flex items-center justify-center mb-2 p-4 shadow-lg hover:shadow-xl transition-all">
                                                <img src="${brand.logo}" alt="${brand.name}" class="w-full h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-2xl\\'>üè™</div>'">
                                            </div>
                                            <div class="text-sm font-semibold text-center text-gray-700">${brand.name}</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentView === 'mylist') {
                const displayWishes = isGuestMode ? guestWishes : wishes;
                const ownerName = isGuestMode ? (guestOwner?.firstName || guestOwner?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å') : '–ú–æ–π';
                
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50 pb-8 px-6">
                        <div class="flex items-center justify-between mb-6 mt-8">
                            <button onclick="goHome()" class="text-pink-500 font-medium flex items-center gap-1">
                                <span>‚Üê</span> ${isGuestMode ? '–ó–∞–∫—Ä—ã—Ç—å' : '–ù–∞–∑–∞–¥'}
                            </button>
                        </div>
                        <h2 class="text-2xl font-bold mb-6 text-gray-700">${isGuestMode ? 'üéÅ ' + ownerName : ownerName} Wish List</h2>

                        ${!showAddForm && !isGuestMode ? `
                            <button onclick="toggleAddForm()" class="w-full bg-gradient-to-r from-pink-400 to-purple-500 rounded-3xl p-6 shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 text-white font-semibold mb-4">
                                <span class="text-2xl">‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –∂–µ–ª–∞–Ω–∏–µ
                            </button>
                            <button onclick="shareWishList()" class="w-full bg-white border-2 border-pink-300 rounded-3xl p-6 shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 text-pink-600 font-semibold mb-6">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                                </svg>
                                –ü–æ–¥–µ–ª–∏—Ç—å—Å—è Wish List
                            </button>
                        ` : !isGuestMode ? `
                            <div class="bg-white rounded-3xl p-6 shadow-lg mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold text-gray-800">${editingId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–æ–µ –∂–µ–ª–∞–Ω–∏–µ'}</h3>
                                    <button onclick="toggleAddForm()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                                </div>
                                
                                <input type="text" id="wishTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ *" value="${formData.title}" class="w-full p-3 border-2 border-gray-200 rounded-2xl mb-3 focus:border-pink-400 focus:outline-none">
                                
                                <input type="url" id="imageUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ" value="${formData.image}" oninput="previewImage(this.value)" class="w-full p-3 border-2 border-gray-200 rounded-2xl mb-3 focus:border-pink-400 focus:outline-none">
                                
                                ${formData.image ? `
                                    <div class="mb-3 relative">
                                        <img src="${formData.image}" alt="Preview" class="w-full h-48 object-cover rounded-2xl" onerror="this.style.display='none'">
                                        <button type="button" onclick="removeImage()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 shadow-lg hover:bg-red-600">
                                            ‚úï
                                        </button>
                                    </div>
                                ` : ''}
                                
                                <input type="text" id="wishPrice" placeholder="–¶–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 5000 ‚Ç∏)" value="${formData.price}" class="w-full p-3 border-2 border-gray-200 rounded-2xl mb-3 focus:border-pink-400 focus:outline-none">
                                
                                <input type="url" id="shopUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω" value="${formData.shopUrl}" class="w-full p-3 border-2 border-gray-200 rounded-2xl mb-4 focus:border-pink-400 focus:outline-none">
                                
                                <button onclick="saveWish()" class="w-full bg-gradient-to-r from-pink-400 to-purple-500 text-white py-3 rounded-2xl font-semibold hover:shadow-lg transition-all">
                                    ${editingId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}
                                </button>
                            </div>
                        ` : ''}

                        ${displayWishes.length === 0 && !showAddForm ? `
                            <div class="bg-white rounded-3xl p-8 text-center shadow-lg mt-6">
                                <div class="text-6xl mb-4">üíù</div>
                                <p class="text-gray-600 font-medium">${isGuestMode ? '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç' : '–ù–∞—á–Ω–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π!'}</p>
                            </div>
                        ` : `
                            <div class="space-y-4 mt-6">
                                ${displayWishes.map(wish => `
                                    <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
                                        ${wish.image ? `
                                            <a href="${wish.shopUrl || '#'}" ${wish.shopUrl ? 'target="_blank"' : ''} class="block">
                                                <img src="${wish.image}" alt="${wish.title}" class="w-full h-48 object-cover">
                                            </a>
                                        ` : ''}
                                        <div class="p-5">
                                            <h3 class="font-bold text-lg text-gray-800 mb-2">${wish.title}</h3>
                                            ${wish.price ? `<p class="text-pink-600 font-semibold mb-2">${wish.price}</p>` : ''}
                                            ${wish.shopUrl ? `
                                                <a href="${wish.shopUrl}" target="_blank" class="inline-flex items-center gap-1 text-blue-600 text-sm mb-3">
                                                    üõí –ö—É–ø–∏—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ
                                                </a>
                                            ` : ''}
                                            ${!isGuestMode ? `
                                                <div class="flex gap-2 mt-3">
                                                    <button onclick="editWish(${wish.id})" class="p-2 text-blue-500 hover:bg-blue-50 rounded-xl">‚úé</button>
                                                    <button onclick="deleteWish(${wish.id})" class="p-2 text-red-500 hover:bg-red-50 rounded-xl">üóë</button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
            }
        }

        function goHome() { 
            if (isGuestMode) {
                window.location.href = window.location.origin + window.location.pathname;
            } else {
                currentView = 'home';
                render();
            }
        }
        
        function goToMyList() { currentView = 'mylist'; render(); }

        function toggleAddForm() {
            showAddForm = !showAddForm;
            if (!showAddForm) {
                editingId = null;
                formData = { title: '', shopUrl: '', price: '', image: '' };
            }
            render();
        }

        function previewImage(url) {
            if (url && url.startsWith('http')) {
                formData.image = url;
                render();
            }
        }

        function removeImage() {
            formData.image = '';
            render();
        }

        function saveWish() {
            const title = document.getElementById('wishTitle')?.value.trim();
            const imageUrl = document.getElementById('imageUrl')?.value.trim();
            const price = document.getElementById('wishPrice')?.value.trim();
            const shopUrl = document.getElementById('shopUrl')?.value.trim();
            
            if (!title) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');

            if (editingId) {
                wishes = wishes.map(w => w.id === editingId ? { 
                    ...w, 
                    title, 
                    image: imageUrl,
                    price,
                    shopUrl
                } : w);
            } else {
                wishes.unshift({ 
                    id: Date.now(), 
                    title,
                    image: imageUrl,
                    price,
                    shopUrl,
                    createdAt: new Date().toISOString() 
                });
            }
            
            saveWishes();
            editingId = null;
            formData = { title: '', shopUrl: '', price: '', image: '' };
            showAddForm = false;
            render();
        }

        function editWish(id) {
            const wish = wishes.find(w => w.id === id);
            if (wish) {
                editingId = id;
                formData = { 
                    title: wish.title, 
                    image: wish.image || '',
                    price: wish.price || '',
                    shopUrl: wish.shopUrl || ''
                };
                showAddForm = true;
                render();
            }
        }

        function deleteWish(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∂–µ–ª–∞–Ω–∏–µ?')) {
                wishes = wishes.filter(w => w.id !== id);
                saveWishes();
                render();
            }
        }

        function showBrandModal(brandName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-8 shadow-2xl max-w-sm mx-4 transform animate-slideUp relative" onclick="event.stopPropagation()">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors w-8 h-8 flex items-center justify-center">
                        <span class="text-2xl">‚úï</span>
                    </button>
                    <div class="text-center">
                        <div class="text-6xl mb-4">‚ú®</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">${brandName}</h3>
                        <p class="text-gray-600">–°–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è!</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function shareWishList() {
            if (wishes.length === 0) {
                return alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∂–µ–ª–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è!');
            }

            const token = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const shareData = {
                wishes: wishes,
                owner: {
                    username: currentUser.username,
                    firstName: currentUser.firstName
                },
                createdAt: new Date().toISOString()
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem(`share_${token}`, JSON.stringify(shareData));

            const tgLink = `https://t.me/merciwishlitbot?start=share_${token}`;
            const text = `üéÅ –ú–æ–π Wish List –≤ Merci!\n\n–£ –º–µ–Ω—è ${wishes.length} ${wishes.length === 1 ? '–∂–µ–ª–∞–Ω–∏–µ' : wishes.length < 5 ? '–∂–µ–ª–∞–Ω–∏—è' : '–∂–µ–ª–∞–Ω–∏–π'}.\n\n–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π —Å–ø–∏—Å–æ–∫:`;
            
            if (window.Telegram?.WebApp) {
                const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(tgLink)}&text=${encodeURIComponent(text)}`;
                window.Telegram.WebApp.openTelegramLink(shareUrl);
            } else if (navigator.share) {
                navigator.share({ title: '–ú–æ–π Wish List', text: text + '\n' + tgLink });
            } else {
                showShareModal(tgLink);
            }
        }

        function showShareModal(url) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 shadow-2xl max-w-sm mx-4 transform animate-slideUp" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–ø–∏—Å–∫–æ–º</h3>
                    <input type="text" value="${url}" readonly class="w-full p-3 bg-gray-100 border-2 border-gray-300 rounded-xl text-sm mb-3">
                    <button onclick="navigator.clipboard.writeText('${url}'); alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); this.closest('.fixed').remove();" class="w-full bg-gradient-to-r from-pink-400 to-purple-500 text-white py-3 rounded-xl font-semibold">
                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        initUser();
        render();
    </script>
</body>
</html>
